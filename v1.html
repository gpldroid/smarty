<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>DAMI IPTV - VLC Edition</title>
    <meta name="description" content="IPTV Player سريع يدعم VLC وروابط HTTP.">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/716/716429.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #ff5722; /* لون برتقالي شبيه بـ VLC */
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
        }

        body.light-mode {
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #212121;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* Header */
        .app-header {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 1050;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .app-logo { font-weight: 700; font-size: 1.4rem; color: #fff; text-decoration: none; }
        .app-logo span { color: var(--primary); }

        /* Player Area */
        .player-wrapper {
            position: sticky;
            top: 65px;
            z-index: 1000;
            background: #000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        video { width: 100%; aspect-ratio: 16/9; background: #000; }

        .vlc-overlay {
            background: #111;
            color: #fff;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--primary);
        }

        /* Search */
        .search-box {
            background: var(--card-bg);
            border: 1px solid rgba(128,128,128,0.2);
            border-radius: 50px;
            padding: 8px 20px;
            width: 100%;
            color: var(--text);
        }
        .search-box:focus { outline: 2px solid var(--primary); }

        /* Channels Grid */
        .channel-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            border: 1px solid transparent;
        }
        .channel-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.2);
        }
        .channel-card img {
            width: 50px; height: 50px;
            object-fit: contain;
            background: #fff;
            border-radius: 50%;
            padding: 2px;
            margin-bottom: 8px;
        }
        .channel-name { font-size: 0.85rem; font-weight: 600; line-height: 1.3; }

        /* Sidebar */
        .offcanvas { background-color: #1e1e1e; color: #fff; }
        .country-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .country-item:hover { background: var(--primary); color: #fff; }

        /* Tools */
        .btn-action {
            border-radius: 8px;
            font-size: 0.9rem;
            padding: 8px 16px;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container-fluid px-3 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <button class="btn text-white p-0" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                    <i class="bi bi-list fs-2"></i>
                </button>
                <a href="#" class="app-logo">DAMI<span>IPTV</span></a>
            </div>
            
            <div class="d-none d-md-block flex-grow-1 mx-5">
                <input type="text" id="desktopSearch" class="search-box" placeholder="بحث سريع في القنوات الحالية..." oninput="filterLocalChannels(this.value)">
            </div>

            <button class="btn btn-outline-light btn-sm rounded-pill" onclick="toggleTheme()">
                <i class="bi bi-circle-half"></i>
            </button>
        </div>
    </header>

    <div class="container d-md-none mt-2">
        <input type="text" id="mobileSearch" class="search-box" placeholder="بحث..." oninput="filterLocalChannels(this.value)">
    </div>

    <div class="container-fluid p-0 mt-3">
        
        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title fw-bold">الدول المتاحة</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="p-2">
                <input type="text" class="form-control bg-dark text-white border-secondary" placeholder="بحث عن دولة..." oninput="filterCountries(this.value)">
            </div>
            <div class="offcanvas-body p-0" id="countryList"></div>
        </div>

        <div class="row g-0 justify-content-center">
            <div class="col-12 col-lg-10">
                
                <div class="player-wrapper rounded-3 overflow-hidden">
                    <div id="vlc-notice" class="vlc-overlay d-none">
                        <i class="bi bi-cone-striped fs-1 text-warning mb-2"></i>
                        <h5>تم اختيار مشغل خارجي</h5>
                        <p class="small text-muted mb-3">هذه القناة قد تتطلب مشغل VLC لتعمل بكفاءة.</p>
                        <a id="vlc-link" href="#" class="btn btn-primary w-100 py-2">
                            <i class="bi bi-play-fill"></i> فتح في VLC Player
                        </a>
                        <button onclick="closeVlcNotice()" class="btn btn-sm btn-link text-white mt-2">إغلاق والمحاولة بالمتصفح</button>
                    </div>
                    
                    <video id="webPlayer" controls playsinline></video>
                </div>

                <div class="d-flex gap-2 my-3 px-3 overflow-x-auto">
                    <button class="btn btn-action btn-primary" onclick="document.getElementById('m3uUpload').click()">
                        <i class="bi bi-upload"></i> رفع ملف M3U
                    </button>
                    <button class="btn btn-action btn-outline-primary" onclick="loadFromUrl()">
                        <i class="bi bi-link"></i> رابط خارجي
                    </button>
                    <input type="file" id="m3uUpload" hidden accept=".m3u,.m3u8">
                    
                    <div class="ms-auto text-muted align-self-center small" id="countDisplay">0 قناة</div>
                </div>

                <div class="px-2 pb-5">
                    <div class="row g-2" id="channelsContainer">
                        <div class="col-12 text-center py-5 text-muted">
                            <i class="bi bi-tv fs-1 d-block mb-2"></i>
                            اختر دولة أو ارفع ملفاً للبدء
                        </div>
                    </div>
                    <div id="loadingSentinel" class="text-center py-3 d-none">
                        <div class="spinner-border text-primary spinner-border-sm"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        // --- State Management ---
        let allChannels = []; // Holds parsed channels
        let filteredChannels = []; // Holds search results
        let visibleCount = 0; // Number of currently rendered items
        const BATCH_SIZE = 48; // How many to load at once
        let hlsPlayer = null;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchCountries();
            setupInfiniteScroll();
            
            // File Upload Listener
            document.getElementById('m3uUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => parseAndLoad(e.target.result);
                reader.readAsText(file);
            });
        });

        // --- Logic: Countries ---
        let countriesData = [];
        async function fetchCountries() {
            try {
                const res = await fetch('https://iptv-org.github.io/api/countries.json');
                countriesData = await res.json();
                renderCountries(countriesData);
            } catch(e) { console.error("Error loading countries"); }
        }

        function renderCountries(list) {
            const container = document.getElementById('countryList');
            container.innerHTML = list.sort((a,b) => a.name.localeCompare(b.name)).map(c => `
                <div class="country-item d-flex align-items-center" onclick="loadCountry('${c.code}')">
                    <img src="https://flagcdn.com/w40/${c.code.toLowerCase()}.png" width="24" class="me-3 rounded shadow-sm">
                    <span class="text-truncate">${c.name}</span>
                </div>
            `).join('');
        }

        function filterCountries(q) {
            const filtered = countriesData.filter(c => c.name.toLowerCase().includes(q.toLowerCase()));
            renderCountries(filtered);
        }

        // --- Logic: Channels Loading & Parsing ---
        async function loadCountry(code) {
            const btn = document.querySelector(`[onclick="loadCountry('${code}')"]`);
            if(btn) btn.innerHTML += ' <span class="spinner-border spinner-border-sm"></span>';
            
            try {
                const res = await fetch(`https://iptv-org.github.io/iptv/countries/${code.toLowerCase()}.m3u`);
                const text = await res.text();
                parseAndLoad(text);
                
                // Close sidebar on mobile
                const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'));
                if(sidebar) sidebar.hide();
            } catch(e) {
                alert('فشل تحميل القنوات');
            }
        }

        function loadFromUrl() {
            const url = prompt("الصق رابط القنوات (M3U):");
            if(url) {
                fetch(url).then(r => r.text()).then(parseAndLoad).catch(() => alert('رابط غير صالح'));
            }
        }

        function parseAndLoad(m3uText) {
            // Regex parsing is faster for large files
            const lines = m3uText.split('\n');
            allChannels = [];
            let currentChannel = {};

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const info = line.split(',');
                    currentChannel.name = info[info.length - 1];
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                    currentChannel.logo = logoMatch ? logoMatch[1] : '';
                } else if (line.startsWith('http')) {
                    currentChannel.url = line;
                    allChannels.push({...currentChannel});
                    currentChannel = {};
                }
            }

            filteredChannels = allChannels;
            document.getElementById('countDisplay').innerText = `${allChannels.length} قناة`;
            resetGrid();
        }

        // --- Logic: Rendering & Virtual Scroll ---
        function resetGrid() {
            document.getElementById('channelsContainer').innerHTML = '';
            visibleCount = 0;
            renderNextBatch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderNextBatch() {
            const container = document.getElementById('channelsContainer');
            const total = filteredChannels.length;
            if (visibleCount >= total) {
                document.getElementById('loadingSentinel').classList.add('d-none');
                return;
            }

            document.getElementById('loadingSentinel').classList.remove('d-none');
            
            const fragment = document.createDocumentFragment();
            const end = Math.min(visibleCount + BATCH_SIZE, total);

            for (let i = visibleCount; i < end; i++) {
                const ch = filteredChannels[i];
                const col = document.createElement('div');
                col.className = 'col-4 col-md-3 col-lg-2';
                const safeLogo = ch.logo || 'https://cdn-icons-png.flaticon.com/512/716/716429.png';
                
                col.innerHTML = `
                    <div class="channel-card" onclick="playChannel('${ch.url}', '${ch.name.replace(/'/g, "\\'")}')">
                        <img src="${safeLogo}" loading="lazy" onerror="this.src='https://cdn-icons-png.flaticon.com/512/716/716429.png'">
                        <div class="channel-name text-truncate">${ch.name}</div>
                    </div>
                `;
                fragment.appendChild(col);
            }

            container.appendChild(fragment);
            visibleCount = end;
            
            if (visibleCount >= total) {
                document.getElementById('loadingSentinel').classList.add('d-none');
            }
        }

        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    renderNextBatch();
                }
            });
        }

        function filterLocalChannels(query) {
            if (!query) {
                filteredChannels = allChannels;
            } else {
                const lower = query.toLowerCase();
                filteredChannels = allChannels.filter(ch => ch.name.toLowerCase().includes(lower));
            }
            resetGrid();
        }

        // --- Logic: Player & VLC ---
        function playChannel(url, name) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const video = document.getElementById('webPlayer');
            const vlcNotice = document.getElementById('vlc-notice');
            const vlcLink = document.getElementById('vlc-link');

            // إعداد رابط VLC
            // نستخدم vlc:// رابط مباشر لفتح البرنامج المثبت
            vlcLink.href = `vlc://${url}`;

            // إذا كان الرابط HTTP والصفحة HTTPS، المتصفح سيرفضه
            // لذا نظهر خيار VLC مباشرة لهذه الحالات أو حسب رغبة المستخدم
            const isHttp = url.startsWith('http://');
            const isHttpsPage = location.protocol === 'https:';

            if (isHttp && isHttpsPage) {
                // محتوى مختلط، المتصفح لن يشغله غالباً
                showVlcOverlay(true);
            } else {
                showVlcOverlay(false); // نحاول التشغيل بالمتصفح أولاً
            }

            // محاولة التشغيل عبر Web Player (HLS.js)
            if (Hls.isSupported()) {
                if (hlsPlayer) hlsPlayer.destroy();
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(url);
                hlsPlayer.attachMedia(video);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                
                // إذا حدث خطأ، نقترح VLC
                hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) showVlcOverlay(true);
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play().catch(() => showVlcOverlay(true));
            }
        }

        function showVlcOverlay(show) {
            const overlay = document.getElementById('vlc-notice');
            const player = document.getElementById('webPlayer');
            
            if (show) {
                overlay.classList.remove('d-none');
                player.classList.add('d-none');
                // إيقاف المشغل الداخلي
                if(hlsPlayer) hlsPlayer.stopLoad();
                player.pause();
            } else {
                overlay.classList.add('d-none');
                player.classList.remove('d-none');
            }
        }

        function closeVlcNotice() {
            showVlcOverlay(false);
            const video = document.getElementById('webPlayer');
            video.play();
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }
    </script>
</body>
</html>
